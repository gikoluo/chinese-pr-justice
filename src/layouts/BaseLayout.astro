---
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

interface Props {
    title: string;
    description?: string;
}

const { title, description = "Justice for Chinese PR Applicants - End Unfair Security Screening Delays" } = Astro.props;
---

<!DOCTYPE html>
<html lang="en" data-lang="en">
<head>
    <script is:inline>
        (function() {
            var lang = (typeof localStorage !== 'undefined' && localStorage.getItem('site-lang')) || 'en';
            var htmlLang = lang === 'zh' ? 'zh-Hans' : (lang === 'fr' ? 'fr' : 'en');
            document.documentElement.lang = htmlLang;
            document.documentElement.setAttribute('data-lang', lang);
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content={description}>
    <title>{title}</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caudex:ital,wght@0,400;0,700;1,400;1,700&family=Work+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <Navbar />

    <slot />

    <Footer />

    <!-- Story full view modal -->
    <div id="story-modal" class="story-modal" role="dialog" aria-modal="true" aria-labelledby="story-modal-title" hidden>
        <div class="story-modal-backdrop"></div>
        <div class="story-modal-box">
            <button type="button" class="story-modal-close" aria-label="Close">&times;</button>
            <div class="story-modal-header">
                <h3 id="story-modal-title" class="story-modal-title"></h3>
                <p class="story-modal-location"></p>
            </div>
            <div class="story-modal-body"></div>
        </div>
    </div>

    <script>
        // Story modal functionality
        (function () {
            const modal = document.getElementById('story-modal');
            if (!modal) return;

            const backdrop = modal.querySelector('.story-modal-backdrop');
            const closeBtn = modal.querySelector('.story-modal-close');
            const titleEl = modal.querySelector('.story-modal-title');
            const locationEl = modal.querySelector('.story-modal-location');
            const bodyEl = modal.querySelector('.story-modal-body');

            function openModal(card: Element) {
                const meta = card.querySelector('.story-meta');
                const full = card.querySelector('.story-content-full');
                if (!meta || !full || !titleEl || !locationEl || !bodyEl) return;
                const titleNode = meta.querySelector('.story-meta-title') || meta.querySelector('h3');
                titleEl.textContent = titleNode?.textContent?.trim() || '';
                locationEl.textContent = meta.querySelector('.story-location')?.textContent?.trim() || '';
                (locationEl as HTMLElement).style.display = locationEl.textContent ? '' : 'none';
                bodyEl.innerHTML = full.innerHTML;
                modal.removeAttribute('hidden');
                document.body.classList.add('story-modal-open');
                (closeBtn as HTMLElement)?.focus();
            }

            function closeModal() {
                modal.setAttribute('hidden', '');
                document.body.classList.remove('story-modal-open');
            }

            document.querySelectorAll('.story-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const card = btn.closest('.story-card');
                    if (card && card.querySelector('.story-content-full')) openModal(card);
                });
            });

            backdrop?.addEventListener('click', closeModal);
            closeBtn?.addEventListener('click', closeModal);
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        })();

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                const href = (this as HTMLAnchorElement).getAttribute('href');
                if (!href || href === '#') return;
                const target = document.querySelector(href);
                if (target) {
                    e.preventDefault();
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add animation on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    (entry.target as HTMLElement).style.opacity = '1';
                    (entry.target as HTMLElement).style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Observe elements for animation
        const animateElements = document.querySelectorAll('.demand-card, .story-card, .join-card, .event-card');
        animateElements.forEach(el => {
            (el as HTMLElement).style.opacity = '0';
            (el as HTMLElement).style.transform = 'translateY(20px)';
            (el as HTMLElement).style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(el);
        });

        // Language switcher: persist choice and toggle display
        function setLang(lang) {
            if (typeof localStorage !== 'undefined') localStorage.setItem('site-lang', lang);
            document.documentElement.lang = lang === 'zh' ? 'zh-Hans' : 'en';
            document.documentElement.setAttribute('data-lang', lang);
        }
        document.querySelectorAll('[data-set-lang]').forEach(function(btn) {
            btn.addEventListener('click', function() { setLang(this.getAttribute('data-set-lang') || 'en'); });
        });

        console.log('Justice for PR Applicants - Website loaded successfully');
    </script>
</body>
</html>
